<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delete and Update Supplier</title>
    <link rel="stylesheet" th:href="@{/css/supplierlist.css}">
</head>
<body>
<div class="container">
    <nav class="navbar">
        <ul>
            <li><a href="/home">Home</a></li>
            <li><a href="/addsupplier">Add Supplier</a></li>
            <li><a href="/supplierlist">Supplier List</a></li>
            <li><a href="/analysis">Analysis</a></li>
            <li><a href="/report">Report</a></li>
        </ul>
    </nav>
    <h1>Supplier List</h1>

    <!-- Search Bar for Supplier ID and Name -->
    <input type="text" id="search" placeholder="Search Supplier by ID/Name/Category/Quality/Rating" onkeyup="searchSupplier()"
           class="search-bar">

    <table class="supplier-table" id="supplierTable" style="width: 100%; border-collapse: collapse;">
        <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Category</th>
            <th>Quality</th>
            <th>Rating</th>
            <th>Min Price</th>
            <th>Max Price</th>
            <th>Email</th>
            <th>Phone</th>
            <th>Address</th>
            <th>Action</th>
        </tr>
        </thead>
        <tbody style="display: block; max-height: 430px; overflow-y: auto; width: 100%;">
        <!-- Example Supplier Rows -->
        <tr th:each="supplier :${suppliers}" style="display: table; table-layout: fixed; width: 100%;">
            <td th:text="${supplier?.id}"></td>
            <td th:text="${supplier?.name}"></td>
            <td th:text="${supplier?.productCategory}"></td>
            <td th:text="${supplier?.productQuality}"></td>
            <td th:text="${supplier?.supplierRating}"></td>
            <td th:text="${supplier?.minPrice}"></td>
            <td th:text="${supplier?.maxPrice}"></td>
            <td th:text="${supplier?.email}"></td>
            <td th:text="${supplier?.phone}"></td>
            <td th:text="${supplier?.supplierAddress}"></td>
            <td style="display: flex; flex-direction: column; gap: 10px; padding: 3px 6px;" >
                <button th:onclick="'confirmDelete(' + ${supplier.id} + ')'">Delete</button>
                <button th:onclick="'openUpdatePopup(' + ${supplier.id} + ')'" style="background-color: #e6a800; color: black;">Update</button>
            </td>
        </tr>
        <!-- Add more suppliers here -->
        </tbody>
    </table>
    <!-- Popup Overlay -->
    <div class="popup-overlay" id="popupOverlay">
        <div class="popup-content">
            <span class="close-btn" onclick="closePopup()">&times;</span>
            <h2>Editing the data of supplier ID(<span id="supplierId"></span>)</h2>
            <form id="supplierForm" th:action="@{/suppliers/update}" method="post">
                <div class="form-group">
                    <label for="name">Supplier Name:</label>
                    <input type="text" id="name" name="name" required>
                </div>
                <div class="form-group">
                    <label for="productCategory">Product Category</label>
                    <select id="productCategory" name="productCategory" required>
                        <option value="" disabled selected>Select Category</option>
                        <option value="Food & Beverage">Food & Beverage</option>
                        <option value="Pharmacy">Pharmacy</option>
                        <option value="Electronics">Electronics</option>
                        <option value="Furniture">Furniture</option>
                        <option value="Clothing">Clothing</option>
                        <option value="Sports">Sports</option>
                        <option value="Grocery">Grocery</option>
                        <option value="Toys">Toys</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="productQuality">Product Quality</label>
                    <select id="productQuality" name="productQuality">
                        <option value="" selected disabled>Select Quality</option>
                        <option value="Very Low">Very Low</option>
                        <option value="Low">Low</option>
                        <option value="Medium">Medium</option>
                        <option value="High">High</option>
                        <option value="High End">High End</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="supplierRating">Rating:</label>
                    <input type="number" id="supplierRating" name="supplierRating" min="0" max="10"
                           value="0" step="0.1" onblur="enforceRatingRange(this)" required>
                </div>
                <div class="form-group">
                    <label for="minPrice">Min Price:</label>
                    <input id="minPrice" name="minPrice" oninput="validatePrices()"
                           required></input>
                </div>

                <div class="form-group">
                    <label for="maxPrice">Max Price:</label>
                    <input id="maxPrice" name="maxPrice" oninput="validatePrices()"
                           required></input>
                    <span id="priceError" style="color: red; display: none;">Max Price must be greater than Min Price.</span>
                </div>
                <div class="form-group">
                    <label for="email">Email:</label>
                    <input type="email" id="email" name="email" required>
                </div>
                <div class="form-group">
                    <label for="phone">Phone:</label>
                    <input type="tel" id="phone" name="phone" required>
                </div>
                <div class="form-group">
                    <label for="supplierAddress">Address:</label>
                    <textarea id="supplierAddress" name="supplierAddress" required></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit">Save</button>
                    <button type="button" onclick="closePopup()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // Function to search suppliers by ID or Name
    function searchSupplier() {
        var input = document.getElementById('search');
        var filter = input.value.toLowerCase();
        var table = document.getElementById('supplierTable');
        var rows = table.getElementsByTagName('tr');

        // Loop through all rows, hide those that don't match the search query
        for (var i = 1; i < rows.length; i++) { // Skip the header row
            var cells = rows[i].getElementsByTagName('td');
            var idCell = cells[0]; // ID column
            var nameCell = cells[1]; // Supplier Name column
            var categoryCell = cells[2]
            var ratingCell = cells[3]
            var qualityCell = cells[4]
            if (idCell || nameCell || categoryCell || ratingCell || qualityCell) {
                var idValue = idCell.textContent || idCell.innerText;
                var nameValue = nameCell.textContent || nameCell.innerText;
                var categoryValue = categoryCell.textContent || categoryCell.innerText;
                var ratingValue = ratingCell.textContent || ratingCell.innerText;
                var qualityValue = qualityCell.textContent || qualityCell.innerText;
                if (idValue.toLowerCase().indexOf(filter) > -1
                || nameValue.toLowerCase().indexOf(filter) > -1
                || categoryValue.toLowerCase().indexOf(filter) > -1
                || ratingValue.toLowerCase().indexOf(filter) > -1
                || qualityValue.toLowerCase().indexOf(filter) > -1)
                {
                    rows[i].style.display = ''; // Show matching rows
                } else {
                    rows[i].style.display = 'none'; // Hide non-matching rows
                }
            }
        }
    }

    // Function to show confirmation dialog before deleting supplier
    function confirmDelete(id) {
        var confirmation = confirm("Are you sure you want to delete this supplier?");
        if (confirmation) {
            deleteSupplier(id);
        }
    }

    // Function to delete supplier row based on ID
    function deleteSupplier(id) {
        fetch(`/suppliers/${id}`, {
            method: 'DELETE',
        })
        .then(response => {
            if (response.ok) {
                // Remove the row from the table
                var table = document.getElementById('supplierTable');
                var rows = table.getElementsByTagName('tr');
                for (var i = 1; i < rows.length; i++) {
                    var row = rows[i];
                    var td = row.getElementsByTagName('td')[0];
                    if (td && td.textContent == id) {
                        table.deleteRow(i);
                        break;
                    }
                }
            } else {
                alert("Failed to delete supplier.");
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    // Function to open the update popup and populate it with the selected supplier's data
    function openUpdatePopup(id) {
        // Find the row with the matching ID
        var table = document.getElementById('supplierTable');
        var rows = table.getElementsByTagName('tr');
        for (var i = 1; i < rows.length; i++) { // Skip the header row
            var row = rows[i];
            var td = row.getElementsByTagName('td')[0];
            if (td && td.textContent == id) {
                // Populate the form with the supplier's data
                var cells = row.getElementsByTagName('td');
                document.getElementById('supplierId').textContent = id;
                document.getElementById('name').value = cells[1].textContent;
                document.getElementById('productCategory').value = cells[2].textContent;
                document.getElementById('productQuality').value = cells[3].textContent;
                document.getElementById('supplierRating').value = cells[4].textContent;
                document.getElementById('minPrice').value = cells[5].textContent;
                document.getElementById('maxPrice').value = cells[6].textContent;
                document.getElementById('email').value = cells[7].textContent;
                document.getElementById('phone').value = cells[8].textContent;
                document.getElementById('supplierAddress').value = cells[9].textContent;

                // Show the popup
                document.getElementById('popupOverlay').style.display = 'flex';
                break;
            }
        }
    }

    // Close popup
    function closePopup() {
        document.getElementById('popupOverlay').style.display = 'none';
    }

    // Validate that maxPrice is greater than minPrice
    function validatePrices() {
        const minPrice = parseFloat(document.getElementById("minPrice").value);
        const maxPrice = parseFloat(document.getElementById("maxPrice").value);
        const priceError = document.getElementById("priceError");

        if (isNaN(minPrice) || isNaN(maxPrice)) {
            priceError.style.display = "none"; // Hide error if inputs are not numbers
            return true; // Allow form submission (let HTML5 validation handle it)
        }

        if (maxPrice <= minPrice) {
            priceError.style.display = "inline"; // Show error message
            return false; // Prevent form submission
        } else {
            priceError.style.display = "none"; // Hide error message
            return true; // Allow form submission
        }
    }

    // Handle form submission
    document.getElementById("supplierForm").addEventListener("submit", function(event) {
        event.preventDefault(); // Prevent the default form submission

        if (!validatePrices()) {
            return; // Prevent form submission if validation fails
        }

        const formData = new FormData(this);
        const supplierId = document.getElementById('supplierId').textContent;

        fetch(`/suppliers/update/${supplierId}`, {
            method: 'POST',
            body: formData
        })
        .then(response => {
            if (response.ok) {
                alert("Supplier updated successfully!");
                closePopup(); // Close the popup
                location.reload(); // Refresh the page to reflect changes
            } else {
                throw new Error("Supplier with the same name and same category already exists!");
            }
        })
        .catch(error => {
            alert(error.message);
        });
    });

    function enforceRatingRange(input) {
        const min = 0.1; // Minimum allowed value
        const max = 10.0; // Maximum allowed value

        // Parse the input value as a float
        let value = parseFloat(input.value);

        // Check if the value is less than 0.1 or greater than 10
        if (isNaN(value) || value < min) {
            input.value = min; // Reset to 0.1 if less than 0.1 or invalid
        } else if (value > max) {
            input.value = max; // Reset to 10 if greater than 10
        }
    }
</script>

</body>
</html>